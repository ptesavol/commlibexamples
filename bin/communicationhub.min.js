function CommunicationHub(){var a=this,b=null,c=null,d=new Object,e=new Object,f=new Object,g=new Object,h=(new Object,null),i=null,j=null,k=function(){var a=new Array,b=os.networkInterfaces();return Object.keys(b).forEach(function(c){b[c].forEach(function(b){"IPv4"===b.family&&b.internal===!1&&a.push(b.address)})}),a};a.onDisconnected=function(b){d.hasOwnProperty(b)&&(a.notifyAllClientsInGroup(d[b].groupId,"onClientDisconnected",[d[b]]),delete e[d[b].groupId][b],delete d[b]),f.hasOwnProperty(b)&&(delete g[f[b].ip][b],delete f[b])},a.registerAsHub=function(a,b,c,d){var e=h.getConnection(c).getRemoteAddress();f[c]={connectionId:c,ip:e,localIps:a,port:b},g.hasOwnProperty(e)||(g[e]=new Object),g[e][c]={connectionId:c,ip:e,localIps:a,port:b},d(null,"OK")},a.notifyAllClientsInGroup=function(a,b,c){if(e.hasOwnProperty(a))for(var d in e[a])h.callRpc(b,c,null,null,d)},a.registerAsClient=function(b,c,f,g,h){e.hasOwnProperty(f)||(e[f]=new Object),d[g]={clientId:g,clientType:c,groupId:f},e[f][g]={clientId:g,clientType:c,groupId:f},h(null,g),a.notifyAllClientsInGroup(f,"onClientConnected",[{clientId:g,clientType:c,groupId:f}])},a.constructPipe=function(b,c,d,e){h.callRpc("requestPipe",[d,c],a,function(){e(null,"Ok")},b)},a.registerAsPipe=function(a,b,c){h.setupPipe(a,b),c(null,"Ok")},a.callClientRpc=function(b,c,d,e,f){d.push(e),h.callRpc(c,d,a,f,b)},a.notifyAll=function(a,b,c){},a.getConnectedClients=function(a,b,c){c(null,e[a])},a.getLocalHubs=function(a,b){var c=h.getConnection(a).getRemoteAddress(),d=null;g.hasOwnProperty(c)&&(d=g[c]),b(null,d)};var l=function(d,e){j=new WebSocketRpcConnection;var f={host:d,port:e};j.connect(f,function(){var d=null;d=null==c||""==c?k():[c],j.getCommunicator().callRpc("registerAsHub",[d,b],a,function(a,b){})})};a.run=function(){var d=minimist(process.argv.slice(2),{string:["host","port","parenthost","parentport"],"default":{host:LISTEN_ADDRESS.host,port:LISTEN_ADDRESS.port}});b=d.port,c=d.host,h=new RpcCommunicator,i=new WebSocketServer,h.exposeRpcMethod("registerAsHub",a,a.registerAsHub),h.exposeRpcMethod("registerAsClient",a,a.registerAsClient),h.exposeRpcMethod("registerAsPipe",a,a.registerAsPipe),h.exposeRpcMethod("constructPipe",a,a.constructPipe),h.exposeRpcMethod("callClientRpc",a,a.callClientRpc),h.exposeRpcMethod("notifyAll",a,a.notifyAll),h.exposeRpcMethod("getConnectedClients",a,a.getConnectedClients),h.exposeRpcMethod("getLocalHubs",a,a.getLocalHubs),h.setDisconnectionListener(a,a.onDisconnected),i.setConnectionListener(h),i.listen({host:d.host,port:d.port},function(a,b){a||d.parenthost&&d.parentport&&l(d.parenthost,d.parentport)})}}!function(){var a={assert:!0,buffer:!0,child_process:!0,cluster:!0,crypto:!0,dgram:!0,dns:!0,events:!0,fs:!0,http:!0,https:!0,net:!0,os:!0,path:!0,punycode:!0,querystring:!0,readline:!0,repl:!0,string_decoder:!0,tls:!0,tty:!0,url:!0,util:!0,vm:!0,zlib:!0},b=function(a){var b={id:module.id,parent:module.parent,filename:module.filename,loaded:!1,children:[],paths:module.paths,exports:{}};return function(){if(!b.loaded&&!b.__isLoading){b.__isLoading=!0;try{a(b,b.exports),b.__isLoading=!1}catch(c){throw b.__isLoading=!1,c}b.loaded=!0}return b.exports}},c={"./libs/webjsonrpc/rpccommunicator.js":b(function(a,b){"use strict";function c(){var a=this,b=1,c=new Object,d=null,e=null,f=null,g=new CallbackBuffer,h=new Object,i=0,j=null;a.exposeRpcMethod=function(a,b,d){try{c[a]={object:b,method:d}}catch(e){}},a.setConnectionListener=function(a,b){d={object:a,listener:b}},a.setDisconnectionListener=function(a,b){e={object:a,listener:b}},a.setBinaryListener=function(a){f=a},a.connectionExists=function(a){return"undefined"!=typeof a&&h.hasOwnProperty(a)?!0:!("undefined"!=typeof a||!h.hasOwnProperty(j))},a.getConnection=function(a){return h[a]},a.callRpc=function(c,d,e,f,h){if(a.connectionExists(h))try{"function"==typeof f?(g.pushBack(b,e,f),"undefined"!=typeof h?k({jsonrpc:"2.0",method:c,params:d,id:""+b},h):k({jsonrpc:"2.0",method:c,params:d,id:""+b},j),b++):"undefined"!=typeof h?k({jsonrpc:"2.0",method:c,params:d},h):k({jsonrpc:"2.0",method:c,params:d},j)}catch(i){}},a.notifyAll=function(a,b){try{for(var c in h)k({jsonrpc:"2.0",method:a,params:b,id:null},c)}catch(d){}},a.getBufferedAmount=function(a){return h[a].getBufferedAmount()},a.sendBinary=function(a,b){try{h[b].sendBinary(a)}catch(c){}};var k=function(a,b){try{h[b].send(JSON.stringify(a))}catch(c){}};a.sendMessage=k;var l=function(a,b,c,d){try{if(a){k({jsonrpc:"2.0",error:a,id:c});"undefined"!=typeof a.code?a.code:"","undefined"!=typeof a.path?a.path:"","undefined"!=typeof a.message?a.message:""}else k({jsonrpc:"2.0",result:b,id:c},d)}catch(e){}},m=function(a,b){try{if(!a.jsonrpc||"2.0"!=a.jsonrpc||!a.method)return void k({jsonrpc:"2.0",error:{code:-32600,message:"Invalid JSON-RPC."},id:null},b);if("[object Array]"!==Object.prototype.toString.call(a.params))return void k({jsonrpc:"2.0",error:{code:-32602,message:"Parameters must be sent inside an array."},id:a.id},b);if(!c.hasOwnProperty(a.method))return null!=a.id?void k({jsonrpc:"2.0",error:{code:-32601,message:"Method "+a.method+" not found."},id:a.id},b):void k({jsonrpc:"2.0",error:{code:-32601,message:"Method "+a.method+" not found."},id:null},b);var d=c[a.method];"undefined"==typeof a.params&&(a.params=new Array),null!=a.id?(a.params.push(b),a.params.push(function(c,d){l(c,d,a.id,b)}),d.method.apply(d.object,a.params)):(a.params.push(b),a.params.push(function(a,b){}),d.method.apply(d.object,a.params))}catch(e){}},n=function(a){try{var b=null,c=null;"undefined"!=typeof a.error&&(b=a.error),"undefined"!=typeof a.result&&(c=a.result),a.id&&g.callMethodAndPop(a.id,b,c)}catch(d){}},o=function(a,b){try{a.method?m(a,b):n(a)}catch(c){}},p=function(){i++;for(var a=i;;)if(a=Math.floor(4294967296*Math.random()),!h.hasOwnProperty(a))break;return a};a.setupPipe=function(a,b){h.hasOwnProperty(a)&&h.hasOwnProperty(b)&&(h[a].setPipedTo(b),h[b].setPipedTo(a))},a.onMessage=function(a,b){try{var c=b.getPipedTo();if(null!=c)return void h[c].send(a);if(a instanceof ArrayBuffer)return void(f&&f.onBinary(a,b.getId()));var d;try{d=JSON.parse(a)}catch(e){return void k({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},b.getId())}o(d,b.getId())}catch(g){}},a.addConnection=function(b){try{return b.getId()||b.setId(p()),h[b.getId()]=b,b.setListener(a),d&&d.listener.call(d.object,b.getId()),j=b.getId(),b.getId()}catch(c){}},a.onDisconnected=function(b){try{a.closeConnection(b),e&&e.listener.call(e.object,b)}catch(c){}},a.closeConnection=function(a){try{a in h&&(h[a].close(),delete h[a])}catch(b){}}}"undefined"!=typeof b&&(global.CallbackBuffer=i("./callbackbuffer","/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/rpccommunicator.js")),"undefined"!=typeof b&&(a.exports=c)}),"./libs/webjsonrpc/callbackbuffer.js":b(function(a,b){"use strict";function c(a){var b=this,c=new Object;b.pushBack=function(a,b,d){c[a]=[b,d]},b.callMethodAndPop=function(a,b,d){if(!c.hasOwnProperty(a))throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"};c[a][1].call(c[a][0],b,d,a),delete c[a]}}"undefined"!=typeof b&&(a.exports=c)}),"./libs/webjsonrpc/websocketserver.js":b(function(a,b){"use strict";function c(){var a=this,b={},c=null,d=null,e=null;a.setConnectionListener=function(a){c=a},a.listen=function(a,f){try{if(b.host=a.host||null,b.port=a.port||"",b.isSsl=a.isSsl||!1,b.sslKey=a.sslKey||"",b.sslCert=a.sslCert||"",b.sslAuthCert=a.sslAuthCert||"",b.owner=a.owner||"-",b.connectionListener=a.connectionListener||null,b.unknMethodListener=a.unknownMethodListener||null,b.protocol=b.isSsl?"wss":"ws",b["class"]="WebSocketServer",b.isSsl){var g=fs.sync.readFile(b.sslKey),h=fs.sync.readFile(b.sslCert),i=fs.sync.readFile(b.sslAuthCert,"utf8");e=https.createServer({key:g,cert:h,ca:i},function(a,b){logger.log("httpsServer::on(request)"),b.writeHead(501),b.end("Not implemented")})}else e=http.createServer(function(a,b){logger.log("httpServer::on(request)"),b.writeHead(501),b.end("Not implemented")});e.listen(b.port,b.host,511,function(){f(null,!0)}),e.on("error",function(a){f(a,null)}),d=new WSServer({httpServer:e,autoAcceptConnections:!1,keepalive:!0,keepaliveInterval:6e4,dropConnectionOnKeepaliveTimeout:!0,keepaliveGracePeriod:1e4}),d.on("request",function(a){logger.info("wsServer::on(request)");try{var b=new WebSocketConnection;b.setSocket(a.accept("json-rpc",a.origin)),b.setRemoteAddress(a.remoteAddress),b.setRemotePort(a.remotePort),b.setOrigin(a.origin);var d=URL.parse(a.resourceURL,!0).query;d&&d.id&&b.setId(d.id),c.addConnection(b)}catch(e){return}}),d.on("close",function(a,b,c){logger.info("wsServer::on(close) ")})}catch(j){}},a.close=function(){try{d&&(d.shutDown(),d=null),e&&(e.close(),e=null)}catch(a){}}}"undefined"!=typeof b&&(global.URL=require("url"),global.fs=require("fs"),global.http=require("http"),global.https=require("https"),global.WSServer=require("websocket").server,global.WebSocketConnection=i("./websocketconnection","/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketserver.js"),global.logger=require("winston")),"undefined"!=typeof b&&(a.exports=c)}),"./libs/webjsonrpc/websocketconnection.js":b(function(a,b){"use strict";function c(){var a=this,b=null,c=null,d=null,e=null,f=null,g=null,h=null;a.connect=function(c,d){c.protocol=c.isSsl?"wss":"ws";try{var e=c.protocol+"://"+c.host+":"+c.port+"/json-rpc";c.id&&(e+="?id="+c.id),b=new WebSocket(e,"json-rpc"),b.binaryType="arraybuffer",b.onopen=function(){d(null)},b.onmessage=j,b.onclose=function(b,c){k(b,c,a)}}catch(f){}},a.setSocket=function(c){try{b=c,b.on("message",i),b.on("close",function(b,c){k(b,c,a)})}catch(d){}},a.setId=function(a){c=a},a.setPipedTo=function(a){h=a},a.getPipedTo=function(){return h},a.setRemoteAddress=function(a){d=a},a.setRemotePort=function(a){e=a},a.setOrigin=function(a){f=a},a.setListener=function(a){g=a},a.getId=function(){return c},a.getRemoteAddress=function(){return d},a.getRemotePort=function(){return e},a.getOrigin=function(){return f};var i=function(b){try{g&&("utf8"==b.type&&g.onMessage(b.utf8Data,a),"binary"==b.type&&g.onMessage(b.binaryData,a))}catch(c){}},j=function(b){try{g&&g.onMessage(b.data,a)}catch(c){}},k=function(a,b,c){try{g&&g.onDisconnected(c.getId())}catch(d){}};a.send=function(a){try{b.send(a)}catch(c){}},a.sendBinary=a.send,a.close=function(){try{b.close()}catch(a){}}}"undefined"!=typeof b&&(global.WebSocket=require("websocket").w3cwebsocket,global.logger=require("winston")),"undefined"!=typeof b&&(a.exports=c)}),"./libs/webjsonrpc/websocketrpcconnection.js":b(function(a,b){"use strict";function c(){var a=this,b=new WebSocketConnection,c=new RpcCommunicator;a.callRpc=function(a,b,d,e){return c.callRpc(a,b,d,e)},a.connect=function(a,d){b.connect(a,function(){c.addConnection(b),d(null,null)})},a.close=function(){},a.getCommunicator=function(){return c}}"undefined"!=typeof b&&(global.RpcCommunicator=i("./rpccommunicator","/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketrpcconnection.js"),global.WebSocketConnection=i("./websocketconnection","/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketrpcconnection.js")),"undefined"!=typeof b&&(a.exports=c)})},d={"/users/ptesavol/projects/communicationplatform/communicationhub.js":"/Users/ptesavol/projects/communicationplatform/communicationhub.js","/users/ptesavol/projects/communicationplatform/libs/webjsonrpc/rpccommunicator.js":"/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/rpccommunicator.js","/users/ptesavol/projects/communicationplatform/libs/webjsonrpc/callbackbuffer.js":"/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/callbackbuffer.js","/users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketserver.js":"/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketserver.js","/users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketconnection.js":"/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketconnection.js","/users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketrpcconnection.js":"/Users/ptesavol/projects/communicationplatform/libs/webjsonrpc/websocketrpcconnection.js"},e=require("path"),f=function(a,b){var c=e.relative(a,b);return/^[\./\\]/.test(c)||/:\//.test(c)||(c="./"+c),-1===c.indexOf(":")&&(c=c.replace(/\\/g,"/")),c},g="/Users/ptesavol/projects/communicationplatform/communicationhub.js",h=function(a){var b=c.hasOwnProperty(a)?c[a]:null;return b||(a=d[a],a&&(b=c.hasOwnProperty(a)?c[a]:null)),b},i=function(b,c){if(!a.hasOwnProperty(b)){var d;c?(d=e.resolve(e.dirname(c),b),d=f(e.dirname(g),d)):d=f(__dirname,b);var i=h(d)||h(d+".js")||h(d+".json");if(i)return i();try{return require(d)}catch(j){}}return require(b)};this.__FAKE_REQUIRE__=i}(),"undefined"!=typeof exports&&(global.RpcCommunicator=__FAKE_REQUIRE__("./libs/webjsonrpc/rpccommunicator","/Users/ptesavol/projects/communicationplatform/communicationhub.js"),global.WebSocketServer=__FAKE_REQUIRE__("./libs/webjsonrpc/websocketserver","/Users/ptesavol/projects/communicationplatform/communicationhub.js"),global.WebSocketRpcConnection=__FAKE_REQUIRE__("./libs/webjsonrpc/websocketrpcconnection","/Users/ptesavol/projects/communicationplatform/communicationhub.js"),global.minimist=require("minimist"),global.os=require("os"));var LISTEN_ADDRESS={host:"",port:"1979"},hub=new CommunicationHub;hub.run();